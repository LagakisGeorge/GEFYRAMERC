

with sums as (
select 
(SELECT TOP 1 SUBVAL FROM VATANAL WHERE VAT=1130 AND  FINDOC=FINDOC.FINDOC) as KAU13,
(SELECT TOP 1 SUBVAL FROM VATANAL WHERE VAT=1224 AND  FINDOC=FINDOC.FINDOC)-EXPN AS KAU24XORISMETAF,
(SELECT TOP 1 SUBVAL FROM VATANAL WHERE VAT=1217 AND  FINDOC=FINDOC.FINDOC) as KAU17,
(SELECT TOP 1 VATVAL FROM VATANAL WHERE VAT=1217 AND  FINDOC=FINDOC.FINDOC) as FPA17,
(SELECT TOP 1 VATVAL FROM VATANAL WHERE VAT=1060 AND  FINDOC=FINDOC.FINDOC) as FPA7,
(SELECT TOP 1 SUBVAL FROM VATANAL WHERE VAT=1060 AND  FINDOC=FINDOC.FINDOC) as KAU7,

EXPN AS METAFORIKA,
(SELECT  sum(MTRlines.netlineval)   FROM MTRLINES INNER JOIN MTRL  ON MTRL.MTRL=MTRLINES.MTRL WHERE FINDOC=FINDOC.FINDOC  AND CODE='99-24'   ) AS sakkau , 

0 AS KAU0,0 AS SYNOLO,

(SELECT TOP 1 VATVAL FROM VATANAL WHERE VAT=1130 AND  FINDOC=FINDOC.FINDOC) as FPA13,


(SELECT TOP 1 VATVAL FROM VATANAL WHERE VAT=1224 AND  FINDOC=FINDOC.FINDOC) 
-ISNULL(EXPN,0)*24/100 AS FPA241,

(SELECT  sum(MTRlines.netlineval)*24/100   FROM MTRLINES INNER JOIN MTRL  ON MTRL.MTRL=MTRLINES.MTRL WHERE FINDOC=FINDOC.FINDOC  AND CODE='99-24'   )
as FPASAK24 ,



EXPN*24/100 AS FPAMETAF,




  FINCODE,TRNDATE,   
(SELECT NAME FROM TRDR  WHERE TRDR=FINDOC.TRDR) AS EPONYMIA ,

(SELECT AFM FROM TRDR  WHERE TRDR=FINDOC.TRDR) AS AFM ,

 TRDR,VATAMNT,NETAMNT 

from  FINDOC WHERE FISCPRD=2019  AND PERIOD IN (7,8,9) AND ISCANCEL=0 
AND SERIES IN ('7079','7077','7062','7061','7063','7064','7066','7067','7069','7070','7071','7072','7073','7076','7082','7127','7141')

)
SELECT 0 as id, ISNULL(KAU13,0) AS AJ1,
round(isnull(KAU24XORISMETAF,0)-ISNULL(sakkau,0),2) AS AJ2,METAFORIKA AS AJ3,
ISNULL(SAKKAU,0) AS AJ4,0 AS AJ5,0 AS AJI,
round(ISNULL(FPA13,0),2) AS FPA1,
round(ISNULL(FPA241,0)-ISNULL(FPASAK24,0),2) AS FPA2,
round(FPAMETAF,2) as FPA3,ROUND(ISNULL(FPASAK24,0),2) AS FPA4,
 FINCODE,convert(char(10),TRNDATE,103) as hme,EPONYMIA ,AFM   ,isnull(KAU17,0) as AJ6,isnull(FPA17,0) as fpa6,isnull(KAU7,0) AS AJ7,isnull(FPA7,0) as FPA7  FROM SUMS  ORDER BY TRNDATE
